begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|// Copyright (C) 2017 The Android Open Source Project
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Licensed under the Apache License, Version 2.0 (the "License");
end_comment

begin_comment
comment|// you may not use this file except in compliance with the License.
end_comment

begin_comment
comment|// You may obtain a copy of the License at
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// http://www.apache.org/licenses/LICENSE-2.0
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Unless required by applicable law or agreed to in writing, software
end_comment

begin_comment
comment|// distributed under the License is distributed on an "AS IS" BASIS,
end_comment

begin_comment
comment|// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
end_comment

begin_comment
comment|// See the License for the specific language governing permissions and
end_comment

begin_comment
comment|// limitations under the License.
end_comment

begin_package
DECL|package|com.google.gerrit.acceptance.rest.account
package|package
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|rest
operator|.
name|account
package|;
end_package

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|truth
operator|.
name|Truth
operator|.
name|assertThat
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|truth
operator|.
name|Truth8
operator|.
name|assertThat
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|GitUtil
operator|.
name|fetch
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|GitUtil
operator|.
name|pushHead
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|externalids
operator|.
name|ExternalId
operator|.
name|SCHEME_MAILTO
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|externalids
operator|.
name|ExternalId
operator|.
name|SCHEME_USERNAME
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|externalids
operator|.
name|ExternalId
operator|.
name|SCHEME_UUID
import|;
end_import

begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|group
operator|.
name|SystemGroupBackend
operator|.
name|REGISTERED_USERS
import|;
end_import

begin_import
import|import static
name|java
operator|.
name|nio
operator|.
name|charset
operator|.
name|StandardCharsets
operator|.
name|UTF_8
import|;
end_import

begin_import
import|import static
name|java
operator|.
name|util
operator|.
name|stream
operator|.
name|Collectors
operator|.
name|toList
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Constants
operator|.
name|OBJ_BLOB
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Constants
operator|.
name|OBJ_TREE
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ImmutableList
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ImmutableSet
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Iterables
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|AbstractDaemonTest
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|RestResponse
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|TestAccount
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|acceptance
operator|.
name|testsuite
operator|.
name|request
operator|.
name|RequestScopeOperations
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|GlobalCapability
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|common
operator|.
name|data
operator|.
name|Permission
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|exceptions
operator|.
name|DuplicateKeyException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|config
operator|.
name|ConsistencyCheckInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|config
operator|.
name|ConsistencyCheckInfo
operator|.
name|ConsistencyProblemInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|config
operator|.
name|ConsistencyCheckInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|api
operator|.
name|config
operator|.
name|ConsistencyCheckInput
operator|.
name|CheckAccountExternalIdsInput
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|common
operator|.
name|AccountExternalIdInfo
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|AuthException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|extensions
operator|.
name|restapi
operator|.
name|UnprocessableEntityException
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|Account
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|reviewdb
operator|.
name|client
operator|.
name|RefNames
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|ServerInitiated
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|AccountsUpdate
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|externalids
operator|.
name|ExternalId
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|externalids
operator|.
name|ExternalIdNotes
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|externalids
operator|.
name|ExternalIdReader
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|account
operator|.
name|externalids
operator|.
name|ExternalIds
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|extensions
operator|.
name|events
operator|.
name|GitReferenceUpdated
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gerrit
operator|.
name|server
operator|.
name|git
operator|.
name|meta
operator|.
name|MetaDataUpdate
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gson
operator|.
name|reflect
operator|.
name|TypeToken
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|Inject
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|inject
operator|.
name|Provider
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Locale
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Optional
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|api
operator|.
name|errors
operator|.
name|TransportException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|errors
operator|.
name|ConfigInvalidException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|internal
operator|.
name|storage
operator|.
name|dfs
operator|.
name|InMemoryRepository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|junit
operator|.
name|TestRepository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|CommitBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Config
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|ObjectId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|ObjectInserter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|RefUpdate
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|lib
operator|.
name|Repository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|notes
operator|.
name|NoteMap
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|revwalk
operator|.
name|FooterLine
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|revwalk
operator|.
name|RevCommit
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|revwalk
operator|.
name|RevWalk
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|transport
operator|.
name|PushResult
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|transport
operator|.
name|RemoteRefUpdate
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|transport
operator|.
name|RemoteRefUpdate
operator|.
name|Status
import|;
end_import

begin_import
import|import
name|org
operator|.
name|eclipse
operator|.
name|jgit
operator|.
name|util
operator|.
name|MutableInteger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_class
DECL|class|ExternalIdIT
specifier|public
class|class
name|ExternalIdIT
extends|extends
name|AbstractDaemonTest
block|{
DECL|field|accountsUpdateProvider
annotation|@
name|Inject
annotation|@
name|ServerInitiated
specifier|private
name|Provider
argument_list|<
name|AccountsUpdate
argument_list|>
name|accountsUpdateProvider
decl_stmt|;
DECL|field|externalIds
annotation|@
name|Inject
specifier|private
name|ExternalIds
name|externalIds
decl_stmt|;
DECL|field|externalIdReader
annotation|@
name|Inject
specifier|private
name|ExternalIdReader
name|externalIdReader
decl_stmt|;
DECL|field|externalIdNotesFactory
annotation|@
name|Inject
specifier|private
name|ExternalIdNotes
operator|.
name|Factory
name|externalIdNotesFactory
decl_stmt|;
DECL|field|requestScopeOperations
annotation|@
name|Inject
specifier|private
name|RequestScopeOperations
name|requestScopeOperations
decl_stmt|;
annotation|@
name|Test
DECL|method|getExternalIds ()
specifier|public
name|void
name|getExternalIds
parameter_list|()
throws|throws
name|Exception
block|{
name|Collection
argument_list|<
name|ExternalId
argument_list|>
name|expectedIds
init|=
name|getAccountState
argument_list|(
name|user
operator|.
name|id
argument_list|()
argument_list|)
operator|.
name|getExternalIds
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|expectedIdInfos
init|=
name|toExternalIdInfos
argument_list|(
name|expectedIds
argument_list|)
decl_stmt|;
name|RestResponse
name|response
init|=
name|userRestSession
operator|.
name|get
argument_list|(
literal|"/accounts/self/external.ids"
argument_list|)
decl_stmt|;
name|response
operator|.
name|assertOK
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|results
init|=
name|newGson
argument_list|()
operator|.
name|fromJson
argument_list|(
name|response
operator|.
name|getReader
argument_list|()
argument_list|,
operator|new
name|TypeToken
argument_list|<
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
argument_list|>
argument_list|()
block|{}
operator|.
name|getType
argument_list|()
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|results
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|expectedIdInfos
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|getExternalIdsOfOtherUserNotAllowed ()
specifier|public
name|void
name|getExternalIdsOfOtherUserNotAllowed
parameter_list|()
throws|throws
name|Exception
block|{
name|requestScopeOperations
operator|.
name|setApiUser
argument_list|(
name|user
operator|.
name|id
argument_list|()
argument_list|)
expr_stmt|;
name|exception
operator|.
name|expect
argument_list|(
name|AuthException
operator|.
name|class
argument_list|)
expr_stmt|;
name|exception
operator|.
name|expectMessage
argument_list|(
literal|"access database not permitted"
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|id
argument_list|(
name|admin
operator|.
name|id
argument_list|()
operator|.
name|get
argument_list|()
argument_list|)
operator|.
name|getExternalIds
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|getExternalIdsOfOtherUserWithAccessDatabase ()
specifier|public
name|void
name|getExternalIdsOfOtherUserWithAccessDatabase
parameter_list|()
throws|throws
name|Exception
block|{
name|allowGlobalCapabilities
argument_list|(
name|REGISTERED_USERS
argument_list|,
name|GlobalCapability
operator|.
name|ACCESS_DATABASE
argument_list|)
expr_stmt|;
name|Collection
argument_list|<
name|ExternalId
argument_list|>
name|expectedIds
init|=
name|getAccountState
argument_list|(
name|admin
operator|.
name|id
argument_list|()
argument_list|)
operator|.
name|getExternalIds
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|expectedIdInfos
init|=
name|toExternalIdInfos
argument_list|(
name|expectedIds
argument_list|)
decl_stmt|;
name|RestResponse
name|response
init|=
name|userRestSession
operator|.
name|get
argument_list|(
literal|"/accounts/"
operator|+
name|admin
operator|.
name|id
argument_list|()
operator|+
literal|"/external.ids"
argument_list|)
decl_stmt|;
name|response
operator|.
name|assertOK
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|results
init|=
name|newGson
argument_list|()
operator|.
name|fromJson
argument_list|(
name|response
operator|.
name|getReader
argument_list|()
argument_list|,
operator|new
name|TypeToken
argument_list|<
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
argument_list|>
argument_list|()
block|{}
operator|.
name|getType
argument_list|()
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|results
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|expectedIdInfos
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deleteExternalIds ()
specifier|public
name|void
name|deleteExternalIds
parameter_list|()
throws|throws
name|Exception
block|{
name|requestScopeOperations
operator|.
name|setApiUser
argument_list|(
name|user
operator|.
name|id
argument_list|()
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|externalIds
init|=
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|self
argument_list|()
operator|.
name|getExternalIds
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|toDelete
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|expectedIds
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|AccountExternalIdInfo
name|id
range|:
name|externalIds
control|)
block|{
if|if
condition|(
name|id
operator|.
name|canDelete
operator|!=
literal|null
operator|&&
name|id
operator|.
name|canDelete
condition|)
block|{
name|toDelete
operator|.
name|add
argument_list|(
name|id
operator|.
name|identity
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|expectedIds
operator|.
name|add
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
name|assertThat
argument_list|(
name|toDelete
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|RestResponse
name|response
init|=
name|userRestSession
operator|.
name|post
argument_list|(
literal|"/accounts/self/external.ids:delete"
argument_list|,
name|toDelete
argument_list|)
decl_stmt|;
name|response
operator|.
name|assertNoContent
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|results
init|=
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|self
argument_list|()
operator|.
name|getExternalIds
argument_list|()
decl_stmt|;
comment|// The external ID in WebSession will not be set for tests, resulting that
comment|// "mailto:user@example.com" can be deleted while "username:user" can't.
name|assertThat
argument_list|(
name|results
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|results
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|expectedIds
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deleteExternalIdsOfOtherUserNotAllowed ()
specifier|public
name|void
name|deleteExternalIdsOfOtherUserNotAllowed
parameter_list|()
throws|throws
name|Exception
block|{
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|extIds
init|=
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|self
argument_list|()
operator|.
name|getExternalIds
argument_list|()
decl_stmt|;
name|requestScopeOperations
operator|.
name|setApiUser
argument_list|(
name|user
operator|.
name|id
argument_list|()
argument_list|)
expr_stmt|;
name|exception
operator|.
name|expect
argument_list|(
name|AuthException
operator|.
name|class
argument_list|)
expr_stmt|;
name|exception
operator|.
name|expectMessage
argument_list|(
literal|"access database not permitted"
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|id
argument_list|(
name|admin
operator|.
name|id
argument_list|()
operator|.
name|get
argument_list|()
argument_list|)
operator|.
name|deleteExternalIds
argument_list|(
name|extIds
operator|.
name|stream
argument_list|()
operator|.
name|map
argument_list|(
name|e
lambda|->
name|e
operator|.
name|identity
argument_list|)
operator|.
name|collect
argument_list|(
name|toList
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deleteExternalIdOfOtherUserUnderOwnAccount_UnprocessableEntity ()
specifier|public
name|void
name|deleteExternalIdOfOtherUserUnderOwnAccount_UnprocessableEntity
parameter_list|()
throws|throws
name|Exception
block|{
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|extIds
init|=
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|self
argument_list|()
operator|.
name|getExternalIds
argument_list|()
decl_stmt|;
name|requestScopeOperations
operator|.
name|setApiUser
argument_list|(
name|user
operator|.
name|id
argument_list|()
argument_list|)
expr_stmt|;
name|exception
operator|.
name|expect
argument_list|(
name|UnprocessableEntityException
operator|.
name|class
argument_list|)
expr_stmt|;
name|exception
operator|.
name|expectMessage
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"External id %s does not exist"
argument_list|,
name|extIds
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|identity
argument_list|)
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|self
argument_list|()
operator|.
name|deleteExternalIds
argument_list|(
name|extIds
operator|.
name|stream
argument_list|()
operator|.
name|map
argument_list|(
name|e
lambda|->
name|e
operator|.
name|identity
argument_list|)
operator|.
name|collect
argument_list|(
name|toList
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deleteExternalIdsOfOtherUserWithAccessDatabase ()
specifier|public
name|void
name|deleteExternalIdsOfOtherUserWithAccessDatabase
parameter_list|()
throws|throws
name|Exception
block|{
name|allowGlobalCapabilities
argument_list|(
name|REGISTERED_USERS
argument_list|,
name|GlobalCapability
operator|.
name|ACCESS_DATABASE
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|externalIds
init|=
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|self
argument_list|()
operator|.
name|getExternalIds
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|toDelete
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|expectedIds
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|AccountExternalIdInfo
name|id
range|:
name|externalIds
control|)
block|{
if|if
condition|(
name|id
operator|.
name|canDelete
operator|!=
literal|null
operator|&&
name|id
operator|.
name|canDelete
condition|)
block|{
name|toDelete
operator|.
name|add
argument_list|(
name|id
operator|.
name|identity
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|expectedIds
operator|.
name|add
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
name|assertThat
argument_list|(
name|toDelete
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|requestScopeOperations
operator|.
name|setApiUser
argument_list|(
name|user
operator|.
name|id
argument_list|()
argument_list|)
expr_stmt|;
name|RestResponse
name|response
init|=
name|userRestSession
operator|.
name|post
argument_list|(
literal|"/accounts/"
operator|+
name|admin
operator|.
name|id
argument_list|()
operator|+
literal|"/external.ids:delete"
argument_list|,
name|toDelete
argument_list|)
decl_stmt|;
name|response
operator|.
name|assertNoContent
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|results
init|=
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|id
argument_list|(
name|admin
operator|.
name|id
argument_list|()
operator|.
name|get
argument_list|()
argument_list|)
operator|.
name|getExternalIds
argument_list|()
decl_stmt|;
comment|// The external ID in WebSession will not be set for tests, resulting that
comment|// "mailto:user@example.com" can be deleted while "username:user" can't.
name|assertThat
argument_list|(
name|results
argument_list|)
operator|.
name|hasSize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|results
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|expectedIds
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deleteExternalIdOfPreferredEmail ()
specifier|public
name|void
name|deleteExternalIdOfPreferredEmail
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|preferredEmail
init|=
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|self
argument_list|()
operator|.
name|get
argument_list|()
operator|.
name|email
decl_stmt|;
name|assertThat
argument_list|(
name|preferredEmail
argument_list|)
operator|.
name|isNotNull
argument_list|()
expr_stmt|;
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|self
argument_list|()
operator|.
name|deleteExternalIds
argument_list|(
name|ImmutableList
operator|.
name|of
argument_list|(
name|ExternalId
operator|.
name|Key
operator|.
name|create
argument_list|(
name|SCHEME_MAILTO
argument_list|,
name|preferredEmail
argument_list|)
operator|.
name|get
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|self
argument_list|()
operator|.
name|get
argument_list|()
operator|.
name|email
argument_list|)
operator|.
name|isNull
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deleteExternalIds_Conflict ()
specifier|public
name|void
name|deleteExternalIds_Conflict
parameter_list|()
throws|throws
name|Exception
block|{
name|List
argument_list|<
name|String
argument_list|>
name|toDelete
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|String
name|externalIdStr
init|=
literal|"username:"
operator|+
name|user
operator|.
name|username
argument_list|()
decl_stmt|;
name|toDelete
operator|.
name|add
argument_list|(
name|externalIdStr
argument_list|)
expr_stmt|;
name|RestResponse
name|response
init|=
name|userRestSession
operator|.
name|post
argument_list|(
literal|"/accounts/self/external.ids:delete"
argument_list|,
name|toDelete
argument_list|)
decl_stmt|;
name|response
operator|.
name|assertConflict
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|response
operator|.
name|getEntityContent
argument_list|()
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"External id %s cannot be deleted"
argument_list|,
name|externalIdStr
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|deleteExternalIds_UnprocessableEntity ()
specifier|public
name|void
name|deleteExternalIds_UnprocessableEntity
parameter_list|()
throws|throws
name|Exception
block|{
name|List
argument_list|<
name|String
argument_list|>
name|toDelete
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|String
name|externalIdStr
init|=
literal|"mailto:user@domain.com"
decl_stmt|;
name|toDelete
operator|.
name|add
argument_list|(
name|externalIdStr
argument_list|)
expr_stmt|;
name|RestResponse
name|response
init|=
name|userRestSession
operator|.
name|post
argument_list|(
literal|"/accounts/self/external.ids:delete"
argument_list|,
name|toDelete
argument_list|)
decl_stmt|;
name|response
operator|.
name|assertUnprocessableEntity
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|response
operator|.
name|getEntityContent
argument_list|()
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"External id %s does not exist"
argument_list|,
name|externalIdStr
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|fetchExternalIdsBranch ()
specifier|public
name|void
name|fetchExternalIdsBranch
parameter_list|()
throws|throws
name|Exception
block|{
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|allUsersRepo
init|=
name|cloneProject
argument_list|(
name|allUsers
argument_list|,
name|user
argument_list|)
decl_stmt|;
comment|// refs/meta/external-ids is only visible to users with the 'Access Database' capability
try|try
block|{
name|fetch
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|fail
argument_list|(
literal|"expected TransportException"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|TransportException
name|e
parameter_list|)
block|{
name|assertThat
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
operator|.
name|isEqualTo
argument_list|(
literal|"Remote does not have "
operator|+
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
operator|+
literal|" available for fetch."
argument_list|)
expr_stmt|;
block|}
name|allowGlobalCapabilities
argument_list|(
name|REGISTERED_USERS
argument_list|,
name|GlobalCapability
operator|.
name|ACCESS_DATABASE
argument_list|)
expr_stmt|;
comment|// re-clone to get new request context, otherwise the old global capabilities are still cached
comment|// in the IdentifiedUser object
name|allUsersRepo
operator|=
name|cloneProject
argument_list|(
name|allUsers
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|fetch
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|pushToExternalIdsBranch ()
specifier|public
name|void
name|pushToExternalIdsBranch
parameter_list|()
throws|throws
name|Exception
block|{
name|allowGlobalCapabilities
argument_list|(
name|REGISTERED_USERS
argument_list|,
name|GlobalCapability
operator|.
name|ACCESS_DATABASE
argument_list|)
expr_stmt|;
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|allUsersRepo
init|=
name|cloneProject
argument_list|(
name|allUsers
argument_list|)
decl_stmt|;
name|fetch
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
operator|+
literal|":"
operator|+
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|allUsersRepo
operator|.
name|reset
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
comment|// different case email is allowed
name|ExternalId
name|newExtId
init|=
name|createExternalIdWithOtherCaseEmail
argument_list|(
literal|"foo:bar"
argument_list|)
decl_stmt|;
name|addExtId
argument_list|(
name|allUsersRepo
argument_list|,
name|newExtId
argument_list|)
expr_stmt|;
name|allUsersRepo
operator|.
name|reset
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|extIdsBefore
init|=
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|self
argument_list|()
operator|.
name|getExternalIds
argument_list|()
decl_stmt|;
name|allowPushOfExternalIds
argument_list|()
expr_stmt|;
name|PushResult
name|r
init|=
name|pushHead
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|r
operator|.
name|getRemoteUpdate
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
operator|.
name|getStatus
argument_list|()
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|Status
operator|.
name|OK
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|extIdsAfter
init|=
name|gApi
operator|.
name|accounts
argument_list|()
operator|.
name|self
argument_list|()
operator|.
name|getExternalIds
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|extIdsAfter
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|Iterables
operator|.
name|concat
argument_list|(
name|extIdsBefore
argument_list|,
name|ImmutableSet
operator|.
name|of
argument_list|(
name|toExternalIdInfo
argument_list|(
name|newExtId
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|pushToExternalIdsBranchRejectsExternalIdWithoutAccountId ()
specifier|public
name|void
name|pushToExternalIdsBranchRejectsExternalIdWithoutAccountId
parameter_list|()
throws|throws
name|Exception
block|{
name|allowGlobalCapabilities
argument_list|(
name|REGISTERED_USERS
argument_list|,
name|GlobalCapability
operator|.
name|ACCESS_DATABASE
argument_list|)
expr_stmt|;
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|allUsersRepo
init|=
name|cloneProject
argument_list|(
name|allUsers
argument_list|)
decl_stmt|;
name|fetch
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
operator|+
literal|":"
operator|+
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|allUsersRepo
operator|.
name|reset
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|insertExternalIdWithoutAccountId
argument_list|(
name|allUsersRepo
operator|.
name|getRepository
argument_list|()
argument_list|,
name|allUsersRepo
operator|.
name|getRevWalk
argument_list|()
argument_list|,
literal|"foo:bar"
argument_list|)
expr_stmt|;
name|allUsersRepo
operator|.
name|reset
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|allowPushOfExternalIds
argument_list|()
expr_stmt|;
name|PushResult
name|r
init|=
name|pushHead
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
decl_stmt|;
name|assertRefUpdateFailure
argument_list|(
name|r
operator|.
name|getRemoteUpdate
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
argument_list|,
literal|"invalid external IDs"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|pushToExternalIdsBranchRejectsExternalIdWithKeyThatDoesntMatchTheNoteId ()
specifier|public
name|void
name|pushToExternalIdsBranchRejectsExternalIdWithKeyThatDoesntMatchTheNoteId
parameter_list|()
throws|throws
name|Exception
block|{
name|allowGlobalCapabilities
argument_list|(
name|REGISTERED_USERS
argument_list|,
name|GlobalCapability
operator|.
name|ACCESS_DATABASE
argument_list|)
expr_stmt|;
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|allUsersRepo
init|=
name|cloneProject
argument_list|(
name|allUsers
argument_list|)
decl_stmt|;
name|fetch
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
operator|+
literal|":"
operator|+
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|allUsersRepo
operator|.
name|reset
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|insertExternalIdWithKeyThatDoesntMatchNoteId
argument_list|(
name|allUsersRepo
operator|.
name|getRepository
argument_list|()
argument_list|,
name|allUsersRepo
operator|.
name|getRevWalk
argument_list|()
argument_list|,
literal|"foo:bar"
argument_list|)
expr_stmt|;
name|allUsersRepo
operator|.
name|reset
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|allowPushOfExternalIds
argument_list|()
expr_stmt|;
name|PushResult
name|r
init|=
name|pushHead
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
decl_stmt|;
name|assertRefUpdateFailure
argument_list|(
name|r
operator|.
name|getRemoteUpdate
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
argument_list|,
literal|"invalid external IDs"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|pushToExternalIdsBranchRejectsExternalIdWithInvalidConfig ()
specifier|public
name|void
name|pushToExternalIdsBranchRejectsExternalIdWithInvalidConfig
parameter_list|()
throws|throws
name|Exception
block|{
name|allowGlobalCapabilities
argument_list|(
name|REGISTERED_USERS
argument_list|,
name|GlobalCapability
operator|.
name|ACCESS_DATABASE
argument_list|)
expr_stmt|;
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|allUsersRepo
init|=
name|cloneProject
argument_list|(
name|allUsers
argument_list|)
decl_stmt|;
name|fetch
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
operator|+
literal|":"
operator|+
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|allUsersRepo
operator|.
name|reset
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|insertExternalIdWithInvalidConfig
argument_list|(
name|allUsersRepo
operator|.
name|getRepository
argument_list|()
argument_list|,
name|allUsersRepo
operator|.
name|getRevWalk
argument_list|()
argument_list|,
literal|"foo:bar"
argument_list|)
expr_stmt|;
name|allUsersRepo
operator|.
name|reset
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|allowPushOfExternalIds
argument_list|()
expr_stmt|;
name|PushResult
name|r
init|=
name|pushHead
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
decl_stmt|;
name|assertRefUpdateFailure
argument_list|(
name|r
operator|.
name|getRemoteUpdate
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
argument_list|,
literal|"invalid external IDs"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|pushToExternalIdsBranchRejectsExternalIdWithEmptyNote ()
specifier|public
name|void
name|pushToExternalIdsBranchRejectsExternalIdWithEmptyNote
parameter_list|()
throws|throws
name|Exception
block|{
name|allowGlobalCapabilities
argument_list|(
name|REGISTERED_USERS
argument_list|,
name|GlobalCapability
operator|.
name|ACCESS_DATABASE
argument_list|)
expr_stmt|;
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|allUsersRepo
init|=
name|cloneProject
argument_list|(
name|allUsers
argument_list|)
decl_stmt|;
name|fetch
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
operator|+
literal|":"
operator|+
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|allUsersRepo
operator|.
name|reset
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|insertExternalIdWithEmptyNote
argument_list|(
name|allUsersRepo
operator|.
name|getRepository
argument_list|()
argument_list|,
name|allUsersRepo
operator|.
name|getRevWalk
argument_list|()
argument_list|,
literal|"foo:bar"
argument_list|)
expr_stmt|;
name|allUsersRepo
operator|.
name|reset
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|allowPushOfExternalIds
argument_list|()
expr_stmt|;
name|PushResult
name|r
init|=
name|pushHead
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
decl_stmt|;
name|assertRefUpdateFailure
argument_list|(
name|r
operator|.
name|getRemoteUpdate
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
argument_list|,
literal|"invalid external IDs"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|pushToExternalIdsBranchRejectsExternalIdForNonExistingAccount ()
specifier|public
name|void
name|pushToExternalIdsBranchRejectsExternalIdForNonExistingAccount
parameter_list|()
throws|throws
name|Exception
block|{
name|testPushToExternalIdsBranchRejectsInvalidExternalId
argument_list|(
name|createExternalIdForNonExistingAccount
argument_list|(
literal|"foo:bar"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|pushToExternalIdsBranchRejectsExternalIdWithInvalidEmail ()
specifier|public
name|void
name|pushToExternalIdsBranchRejectsExternalIdWithInvalidEmail
parameter_list|()
throws|throws
name|Exception
block|{
name|testPushToExternalIdsBranchRejectsInvalidExternalId
argument_list|(
name|createExternalIdWithInvalidEmail
argument_list|(
literal|"foo:bar"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|pushToExternalIdsBranchRejectsDuplicateEmails ()
specifier|public
name|void
name|pushToExternalIdsBranchRejectsDuplicateEmails
parameter_list|()
throws|throws
name|Exception
block|{
name|testPushToExternalIdsBranchRejectsInvalidExternalId
argument_list|(
name|createExternalIdWithDuplicateEmail
argument_list|(
literal|"foo:bar"
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|pushToExternalIdsBranchRejectsBadPassword ()
specifier|public
name|void
name|pushToExternalIdsBranchRejectsBadPassword
parameter_list|()
throws|throws
name|Exception
block|{
name|testPushToExternalIdsBranchRejectsInvalidExternalId
argument_list|(
name|createExternalIdWithBadPassword
argument_list|(
literal|"foo"
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testPushToExternalIdsBranchRejectsInvalidExternalId (ExternalId invalidExtId)
specifier|private
name|void
name|testPushToExternalIdsBranchRejectsInvalidExternalId
parameter_list|(
name|ExternalId
name|invalidExtId
parameter_list|)
throws|throws
name|Exception
block|{
name|allowGlobalCapabilities
argument_list|(
name|REGISTERED_USERS
argument_list|,
name|GlobalCapability
operator|.
name|ACCESS_DATABASE
argument_list|)
expr_stmt|;
name|TestRepository
argument_list|<
name|InMemoryRepository
argument_list|>
name|allUsersRepo
init|=
name|cloneProject
argument_list|(
name|allUsers
argument_list|)
decl_stmt|;
name|fetch
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
operator|+
literal|":"
operator|+
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|allUsersRepo
operator|.
name|reset
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|addExtId
argument_list|(
name|allUsersRepo
argument_list|,
name|invalidExtId
argument_list|)
expr_stmt|;
name|allUsersRepo
operator|.
name|reset
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
expr_stmt|;
name|allowPushOfExternalIds
argument_list|()
expr_stmt|;
name|PushResult
name|r
init|=
name|pushHead
argument_list|(
name|allUsersRepo
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
decl_stmt|;
name|assertRefUpdateFailure
argument_list|(
name|r
operator|.
name|getRemoteUpdate
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
argument_list|,
literal|"invalid external IDs"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|readExternalIdsWhenInvalidExternalIdsExist ()
specifier|public
name|void
name|readExternalIdsWhenInvalidExternalIdsExist
parameter_list|()
throws|throws
name|Exception
block|{
name|allowGlobalCapabilities
argument_list|(
name|REGISTERED_USERS
argument_list|,
name|GlobalCapability
operator|.
name|ACCESS_DATABASE
argument_list|)
expr_stmt|;
name|requestScopeOperations
operator|.
name|resetCurrentApiUser
argument_list|()
expr_stmt|;
name|insertValidExternalIds
argument_list|()
expr_stmt|;
name|insertInvalidButParsableExternalIds
argument_list|()
expr_stmt|;
name|Set
argument_list|<
name|ExternalId
argument_list|>
name|parseableExtIds
init|=
name|externalIds
operator|.
name|all
argument_list|()
decl_stmt|;
name|insertNonParsableExternalIds
argument_list|()
expr_stmt|;
name|Set
argument_list|<
name|ExternalId
argument_list|>
name|extIds
init|=
name|externalIds
operator|.
name|all
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|extIds
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|parseableExtIds
argument_list|)
expr_stmt|;
for|for
control|(
name|ExternalId
name|parseableExtId
range|:
name|parseableExtIds
control|)
block|{
name|Optional
argument_list|<
name|ExternalId
argument_list|>
name|extId
init|=
name|externalIds
operator|.
name|get
argument_list|(
name|parseableExtId
operator|.
name|key
argument_list|()
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|extId
argument_list|)
operator|.
name|hasValue
argument_list|(
name|parseableExtId
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|checkConsistency ()
specifier|public
name|void
name|checkConsistency
parameter_list|()
throws|throws
name|Exception
block|{
name|allowGlobalCapabilities
argument_list|(
name|REGISTERED_USERS
argument_list|,
name|GlobalCapability
operator|.
name|ACCESS_DATABASE
argument_list|)
expr_stmt|;
name|requestScopeOperations
operator|.
name|resetCurrentApiUser
argument_list|()
expr_stmt|;
name|insertValidExternalIds
argument_list|()
expr_stmt|;
name|ConsistencyCheckInput
name|input
init|=
operator|new
name|ConsistencyCheckInput
argument_list|()
decl_stmt|;
name|input
operator|.
name|checkAccountExternalIds
operator|=
operator|new
name|CheckAccountExternalIdsInput
argument_list|()
expr_stmt|;
name|ConsistencyCheckInfo
name|checkInfo
init|=
name|gApi
operator|.
name|config
argument_list|()
operator|.
name|server
argument_list|()
operator|.
name|checkConsistency
argument_list|(
name|input
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|checkInfo
operator|.
name|checkAccountExternalIdsResult
operator|.
name|problems
argument_list|)
operator|.
name|isEmpty
argument_list|()
expr_stmt|;
name|Set
argument_list|<
name|ConsistencyProblemInfo
argument_list|>
name|expectedProblems
init|=
operator|new
name|HashSet
argument_list|<>
argument_list|()
decl_stmt|;
name|expectedProblems
operator|.
name|addAll
argument_list|(
name|insertInvalidButParsableExternalIds
argument_list|()
argument_list|)
expr_stmt|;
name|expectedProblems
operator|.
name|addAll
argument_list|(
name|insertNonParsableExternalIds
argument_list|()
argument_list|)
expr_stmt|;
name|checkInfo
operator|=
name|gApi
operator|.
name|config
argument_list|()
operator|.
name|server
argument_list|()
operator|.
name|checkConsistency
argument_list|(
name|input
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|checkInfo
operator|.
name|checkAccountExternalIdsResult
operator|.
name|problems
argument_list|)
operator|.
name|hasSize
argument_list|(
name|expectedProblems
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|checkInfo
operator|.
name|checkAccountExternalIdsResult
operator|.
name|problems
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|expectedProblems
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|checkConsistencyNotAllowed ()
specifier|public
name|void
name|checkConsistencyNotAllowed
parameter_list|()
throws|throws
name|Exception
block|{
name|exception
operator|.
name|expect
argument_list|(
name|AuthException
operator|.
name|class
argument_list|)
expr_stmt|;
name|exception
operator|.
name|expectMessage
argument_list|(
literal|"access database not permitted"
argument_list|)
expr_stmt|;
name|gApi
operator|.
name|config
argument_list|()
operator|.
name|server
argument_list|()
operator|.
name|checkConsistency
argument_list|(
operator|new
name|ConsistencyCheckInput
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|consistencyError (String message)
specifier|private
name|ConsistencyProblemInfo
name|consistencyError
parameter_list|(
name|String
name|message
parameter_list|)
block|{
return|return
operator|new
name|ConsistencyProblemInfo
argument_list|(
name|ConsistencyProblemInfo
operator|.
name|Status
operator|.
name|ERROR
argument_list|,
name|message
argument_list|)
return|;
block|}
DECL|method|insertValidExternalIds ()
specifier|private
name|void
name|insertValidExternalIds
parameter_list|()
throws|throws
name|Exception
block|{
name|MutableInteger
name|i
init|=
operator|new
name|MutableInteger
argument_list|()
decl_stmt|;
name|String
name|scheme
init|=
literal|"valid"
decl_stmt|;
comment|// create valid external IDs
name|insertExtId
argument_list|(
name|ExternalId
operator|.
name|createWithPassword
argument_list|(
name|ExternalId
operator|.
name|Key
operator|.
name|parse
argument_list|(
name|nextId
argument_list|(
name|scheme
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|,
literal|"admin.other@example.com"
argument_list|,
literal|"secret-password"
argument_list|)
argument_list|)
expr_stmt|;
name|insertExtId
argument_list|(
name|createExternalIdWithOtherCaseEmail
argument_list|(
name|nextId
argument_list|(
name|scheme
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|insertInvalidButParsableExternalIds ()
specifier|private
name|Set
argument_list|<
name|ConsistencyProblemInfo
argument_list|>
name|insertInvalidButParsableExternalIds
parameter_list|()
throws|throws
name|Exception
block|{
name|MutableInteger
name|i
init|=
operator|new
name|MutableInteger
argument_list|()
decl_stmt|;
name|String
name|scheme
init|=
literal|"invalid"
decl_stmt|;
name|Set
argument_list|<
name|ConsistencyProblemInfo
argument_list|>
name|expectedProblems
init|=
operator|new
name|HashSet
argument_list|<>
argument_list|()
decl_stmt|;
name|ExternalId
name|extIdForNonExistingAccount
init|=
name|createExternalIdForNonExistingAccount
argument_list|(
name|nextId
argument_list|(
name|scheme
argument_list|,
name|i
argument_list|)
argument_list|)
decl_stmt|;
name|insertExtIdForNonExistingAccount
argument_list|(
name|extIdForNonExistingAccount
argument_list|)
expr_stmt|;
name|expectedProblems
operator|.
name|add
argument_list|(
name|consistencyError
argument_list|(
literal|"External ID '"
operator|+
name|extIdForNonExistingAccount
operator|.
name|key
argument_list|()
operator|.
name|get
argument_list|()
operator|+
literal|"' belongs to account that doesn't exist: "
operator|+
name|extIdForNonExistingAccount
operator|.
name|accountId
argument_list|()
operator|.
name|get
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|ExternalId
name|extIdWithInvalidEmail
init|=
name|createExternalIdWithInvalidEmail
argument_list|(
name|nextId
argument_list|(
name|scheme
argument_list|,
name|i
argument_list|)
argument_list|)
decl_stmt|;
name|insertExtId
argument_list|(
name|extIdWithInvalidEmail
argument_list|)
expr_stmt|;
name|expectedProblems
operator|.
name|add
argument_list|(
name|consistencyError
argument_list|(
literal|"External ID '"
operator|+
name|extIdWithInvalidEmail
operator|.
name|key
argument_list|()
operator|.
name|get
argument_list|()
operator|+
literal|"' has an invalid email: "
operator|+
name|extIdWithInvalidEmail
operator|.
name|email
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|ExternalId
name|extIdWithDuplicateEmail
init|=
name|createExternalIdWithDuplicateEmail
argument_list|(
name|nextId
argument_list|(
name|scheme
argument_list|,
name|i
argument_list|)
argument_list|)
decl_stmt|;
name|insertExtId
argument_list|(
name|extIdWithDuplicateEmail
argument_list|)
expr_stmt|;
name|expectedProblems
operator|.
name|add
argument_list|(
name|consistencyError
argument_list|(
literal|"Email '"
operator|+
name|extIdWithDuplicateEmail
operator|.
name|email
argument_list|()
operator|+
literal|"' is not unique, it's used by the following external IDs: '"
operator|+
name|extIdWithDuplicateEmail
operator|.
name|key
argument_list|()
operator|.
name|get
argument_list|()
operator|+
literal|"', 'mailto:"
operator|+
name|extIdWithDuplicateEmail
operator|.
name|email
argument_list|()
operator|+
literal|"'"
argument_list|)
argument_list|)
expr_stmt|;
name|ExternalId
name|extIdWithBadPassword
init|=
name|createExternalIdWithBadPassword
argument_list|(
literal|"admin-username"
argument_list|)
decl_stmt|;
name|insertExtId
argument_list|(
name|extIdWithBadPassword
argument_list|)
expr_stmt|;
name|expectedProblems
operator|.
name|add
argument_list|(
name|consistencyError
argument_list|(
literal|"External ID '"
operator|+
name|extIdWithBadPassword
operator|.
name|key
argument_list|()
operator|.
name|get
argument_list|()
operator|+
literal|"' has an invalid password: unrecognized algorithm"
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|expectedProblems
return|;
block|}
DECL|method|insertNonParsableExternalIds ()
specifier|private
name|Set
argument_list|<
name|ConsistencyProblemInfo
argument_list|>
name|insertNonParsableExternalIds
parameter_list|()
throws|throws
name|IOException
block|{
name|MutableInteger
name|i
init|=
operator|new
name|MutableInteger
argument_list|()
decl_stmt|;
name|String
name|scheme
init|=
literal|"corrupt"
decl_stmt|;
name|Set
argument_list|<
name|ConsistencyProblemInfo
argument_list|>
name|expectedProblems
init|=
operator|new
name|HashSet
argument_list|<>
argument_list|()
decl_stmt|;
try|try
init|(
name|Repository
name|repo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|allUsers
argument_list|)
init|;
name|RevWalk
name|rw
operator|=
operator|new
name|RevWalk
argument_list|(
name|repo
argument_list|)
init|)
block|{
name|String
name|externalId
init|=
name|nextId
argument_list|(
name|scheme
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|String
name|noteId
init|=
name|insertExternalIdWithoutAccountId
argument_list|(
name|repo
argument_list|,
name|rw
argument_list|,
name|externalId
argument_list|)
decl_stmt|;
name|expectedProblems
operator|.
name|add
argument_list|(
name|consistencyError
argument_list|(
literal|"Invalid external ID config for note '"
operator|+
name|noteId
operator|+
literal|"': Value for 'externalId."
operator|+
name|externalId
operator|+
literal|".accountId' is missing, expected account ID"
argument_list|)
argument_list|)
expr_stmt|;
name|externalId
operator|=
name|nextId
argument_list|(
name|scheme
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|noteId
operator|=
name|insertExternalIdWithKeyThatDoesntMatchNoteId
argument_list|(
name|repo
argument_list|,
name|rw
argument_list|,
name|externalId
argument_list|)
expr_stmt|;
name|expectedProblems
operator|.
name|add
argument_list|(
name|consistencyError
argument_list|(
literal|"Invalid external ID config for note '"
operator|+
name|noteId
operator|+
literal|"': SHA1 of external ID '"
operator|+
name|externalId
operator|+
literal|"' does not match note ID '"
operator|+
name|noteId
operator|+
literal|"'"
argument_list|)
argument_list|)
expr_stmt|;
name|noteId
operator|=
name|insertExternalIdWithInvalidConfig
argument_list|(
name|repo
argument_list|,
name|rw
argument_list|,
name|nextId
argument_list|(
name|scheme
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|expectedProblems
operator|.
name|add
argument_list|(
name|consistencyError
argument_list|(
literal|"Invalid external ID config for note '"
operator|+
name|noteId
operator|+
literal|"': Invalid line in config file"
argument_list|)
argument_list|)
expr_stmt|;
name|noteId
operator|=
name|insertExternalIdWithEmptyNote
argument_list|(
name|repo
argument_list|,
name|rw
argument_list|,
name|nextId
argument_list|(
name|scheme
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|expectedProblems
operator|.
name|add
argument_list|(
name|consistencyError
argument_list|(
literal|"Invalid external ID config for note '"
operator|+
name|noteId
operator|+
literal|"': Expected exactly 1 'externalId' section, found 0"
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|expectedProblems
return|;
block|}
DECL|method|createExternalIdWithOtherCaseEmail (String externalId)
specifier|private
name|ExternalId
name|createExternalIdWithOtherCaseEmail
parameter_list|(
name|String
name|externalId
parameter_list|)
block|{
return|return
name|ExternalId
operator|.
name|createWithPassword
argument_list|(
name|ExternalId
operator|.
name|Key
operator|.
name|parse
argument_list|(
name|externalId
argument_list|)
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|,
name|admin
operator|.
name|email
argument_list|()
operator|.
name|toUpperCase
argument_list|(
name|Locale
operator|.
name|US
argument_list|)
argument_list|,
literal|"password"
argument_list|)
return|;
block|}
DECL|method|insertExternalIdWithoutAccountId (Repository repo, RevWalk rw, String externalId)
specifier|private
name|String
name|insertExternalIdWithoutAccountId
parameter_list|(
name|Repository
name|repo
parameter_list|,
name|RevWalk
name|rw
parameter_list|,
name|String
name|externalId
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|insertExternalId
argument_list|(
name|repo
argument_list|,
name|rw
argument_list|,
parameter_list|(
name|ins
parameter_list|,
name|noteMap
parameter_list|)
lambda|->
block|{
name|ExternalId
name|extId
init|=
name|ExternalId
operator|.
name|create
argument_list|(
name|ExternalId
operator|.
name|Key
operator|.
name|parse
argument_list|(
name|externalId
argument_list|)
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|)
decl_stmt|;
name|ObjectId
name|noteId
init|=
name|extId
operator|.
name|key
argument_list|()
operator|.
name|sha1
argument_list|()
decl_stmt|;
name|Config
name|c
init|=
operator|new
name|Config
argument_list|()
decl_stmt|;
name|extId
operator|.
name|writeToConfig
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|c
operator|.
name|unset
argument_list|(
literal|"externalId"
argument_list|,
name|extId
operator|.
name|key
argument_list|()
operator|.
name|get
argument_list|()
argument_list|,
literal|"accountId"
argument_list|)
expr_stmt|;
name|byte
index|[]
name|raw
init|=
name|c
operator|.
name|toText
argument_list|()
operator|.
name|getBytes
argument_list|(
name|UTF_8
argument_list|)
decl_stmt|;
name|ObjectId
name|dataBlob
init|=
name|ins
operator|.
name|insert
argument_list|(
name|OBJ_BLOB
argument_list|,
name|raw
argument_list|)
decl_stmt|;
name|noteMap
operator|.
name|set
argument_list|(
name|noteId
argument_list|,
name|dataBlob
argument_list|)
expr_stmt|;
return|return
name|noteId
return|;
block|}
argument_list|)
return|;
block|}
DECL|method|insertExternalIdWithKeyThatDoesntMatchNoteId ( Repository repo, RevWalk rw, String externalId)
specifier|private
name|String
name|insertExternalIdWithKeyThatDoesntMatchNoteId
parameter_list|(
name|Repository
name|repo
parameter_list|,
name|RevWalk
name|rw
parameter_list|,
name|String
name|externalId
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|insertExternalId
argument_list|(
name|repo
argument_list|,
name|rw
argument_list|,
parameter_list|(
name|ins
parameter_list|,
name|noteMap
parameter_list|)
lambda|->
block|{
name|ExternalId
name|extId
init|=
name|ExternalId
operator|.
name|create
argument_list|(
name|ExternalId
operator|.
name|Key
operator|.
name|parse
argument_list|(
name|externalId
argument_list|)
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|)
decl_stmt|;
name|ObjectId
name|noteId
init|=
name|ExternalId
operator|.
name|Key
operator|.
name|parse
argument_list|(
name|externalId
operator|+
literal|"x"
argument_list|)
operator|.
name|sha1
argument_list|()
decl_stmt|;
name|Config
name|c
init|=
operator|new
name|Config
argument_list|()
decl_stmt|;
name|extId
operator|.
name|writeToConfig
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|byte
index|[]
name|raw
init|=
name|c
operator|.
name|toText
argument_list|()
operator|.
name|getBytes
argument_list|(
name|UTF_8
argument_list|)
decl_stmt|;
name|ObjectId
name|dataBlob
init|=
name|ins
operator|.
name|insert
argument_list|(
name|OBJ_BLOB
argument_list|,
name|raw
argument_list|)
decl_stmt|;
name|noteMap
operator|.
name|set
argument_list|(
name|noteId
argument_list|,
name|dataBlob
argument_list|)
expr_stmt|;
return|return
name|noteId
return|;
block|}
argument_list|)
return|;
block|}
DECL|method|insertExternalIdWithInvalidConfig (Repository repo, RevWalk rw, String externalId)
specifier|private
name|String
name|insertExternalIdWithInvalidConfig
parameter_list|(
name|Repository
name|repo
parameter_list|,
name|RevWalk
name|rw
parameter_list|,
name|String
name|externalId
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|insertExternalId
argument_list|(
name|repo
argument_list|,
name|rw
argument_list|,
parameter_list|(
name|ins
parameter_list|,
name|noteMap
parameter_list|)
lambda|->
block|{
name|ObjectId
name|noteId
init|=
name|ExternalId
operator|.
name|Key
operator|.
name|parse
argument_list|(
name|externalId
argument_list|)
operator|.
name|sha1
argument_list|()
decl_stmt|;
name|byte
index|[]
name|raw
init|=
literal|"bad-config"
operator|.
name|getBytes
argument_list|(
name|UTF_8
argument_list|)
decl_stmt|;
name|ObjectId
name|dataBlob
init|=
name|ins
operator|.
name|insert
argument_list|(
name|OBJ_BLOB
argument_list|,
name|raw
argument_list|)
decl_stmt|;
name|noteMap
operator|.
name|set
argument_list|(
name|noteId
argument_list|,
name|dataBlob
argument_list|)
expr_stmt|;
return|return
name|noteId
return|;
block|}
argument_list|)
return|;
block|}
DECL|method|insertExternalIdWithEmptyNote (Repository repo, RevWalk rw, String externalId)
specifier|private
name|String
name|insertExternalIdWithEmptyNote
parameter_list|(
name|Repository
name|repo
parameter_list|,
name|RevWalk
name|rw
parameter_list|,
name|String
name|externalId
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|insertExternalId
argument_list|(
name|repo
argument_list|,
name|rw
argument_list|,
parameter_list|(
name|ins
parameter_list|,
name|noteMap
parameter_list|)
lambda|->
block|{
name|ObjectId
name|noteId
init|=
name|ExternalId
operator|.
name|Key
operator|.
name|parse
argument_list|(
name|externalId
argument_list|)
operator|.
name|sha1
argument_list|()
decl_stmt|;
name|byte
index|[]
name|raw
init|=
literal|""
operator|.
name|getBytes
argument_list|(
name|UTF_8
argument_list|)
decl_stmt|;
name|ObjectId
name|dataBlob
init|=
name|ins
operator|.
name|insert
argument_list|(
name|OBJ_BLOB
argument_list|,
name|raw
argument_list|)
decl_stmt|;
name|noteMap
operator|.
name|set
argument_list|(
name|noteId
argument_list|,
name|dataBlob
argument_list|)
expr_stmt|;
return|return
name|noteId
return|;
block|}
argument_list|)
return|;
block|}
DECL|method|insertExternalId (Repository repo, RevWalk rw, ExternalIdInserter extIdInserter)
specifier|private
name|String
name|insertExternalId
parameter_list|(
name|Repository
name|repo
parameter_list|,
name|RevWalk
name|rw
parameter_list|,
name|ExternalIdInserter
name|extIdInserter
parameter_list|)
throws|throws
name|IOException
block|{
name|ObjectId
name|rev
init|=
name|ExternalIdReader
operator|.
name|readRevision
argument_list|(
name|repo
argument_list|)
decl_stmt|;
name|NoteMap
name|noteMap
init|=
name|ExternalIdReader
operator|.
name|readNoteMap
argument_list|(
name|rw
argument_list|,
name|rev
argument_list|)
decl_stmt|;
try|try
init|(
name|ObjectInserter
name|ins
init|=
name|repo
operator|.
name|newObjectInserter
argument_list|()
init|)
block|{
name|ObjectId
name|noteId
init|=
name|extIdInserter
operator|.
name|addNote
argument_list|(
name|ins
argument_list|,
name|noteMap
argument_list|)
decl_stmt|;
name|CommitBuilder
name|cb
init|=
operator|new
name|CommitBuilder
argument_list|()
decl_stmt|;
name|cb
operator|.
name|setMessage
argument_list|(
literal|"Update external IDs"
argument_list|)
expr_stmt|;
name|cb
operator|.
name|setTreeId
argument_list|(
name|noteMap
operator|.
name|writeTree
argument_list|(
name|ins
argument_list|)
argument_list|)
expr_stmt|;
name|cb
operator|.
name|setAuthor
argument_list|(
name|admin
operator|.
name|newIdent
argument_list|()
argument_list|)
expr_stmt|;
name|cb
operator|.
name|setCommitter
argument_list|(
name|admin
operator|.
name|newIdent
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rev
operator|.
name|equals
argument_list|(
name|ObjectId
operator|.
name|zeroId
argument_list|()
argument_list|)
condition|)
block|{
name|cb
operator|.
name|setParentId
argument_list|(
name|rev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cb
operator|.
name|setParentIds
argument_list|()
expr_stmt|;
comment|// Ref is currently nonexistent, commit has no parents.
block|}
if|if
condition|(
name|cb
operator|.
name|getTreeId
argument_list|()
operator|==
literal|null
condition|)
block|{
if|if
condition|(
name|rev
operator|.
name|equals
argument_list|(
name|ObjectId
operator|.
name|zeroId
argument_list|()
argument_list|)
condition|)
block|{
name|cb
operator|.
name|setTreeId
argument_list|(
name|ins
operator|.
name|insert
argument_list|(
name|OBJ_TREE
argument_list|,
operator|new
name|byte
index|[]
block|{}
argument_list|)
argument_list|)
expr_stmt|;
comment|// No parent, assume empty tree.
block|}
else|else
block|{
name|RevCommit
name|p
init|=
name|rw
operator|.
name|parseCommit
argument_list|(
name|rev
argument_list|)
decl_stmt|;
name|cb
operator|.
name|setTreeId
argument_list|(
name|p
operator|.
name|getTree
argument_list|()
argument_list|)
expr_stmt|;
comment|// Copy tree from parent.
block|}
block|}
name|ObjectId
name|commitId
init|=
name|ins
operator|.
name|insert
argument_list|(
name|cb
argument_list|)
decl_stmt|;
name|ins
operator|.
name|flush
argument_list|()
expr_stmt|;
name|RefUpdate
name|u
init|=
name|repo
operator|.
name|updateRef
argument_list|(
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|)
decl_stmt|;
name|u
operator|.
name|setExpectedOldObjectId
argument_list|(
name|rev
argument_list|)
expr_stmt|;
name|u
operator|.
name|setNewObjectId
argument_list|(
name|commitId
argument_list|)
expr_stmt|;
name|RefUpdate
operator|.
name|Result
name|res
init|=
name|u
operator|.
name|update
argument_list|()
decl_stmt|;
switch|switch
condition|(
name|res
condition|)
block|{
case|case
name|NEW
case|:
case|case
name|FAST_FORWARD
case|:
case|case
name|NO_CHANGE
case|:
case|case
name|RENAMED
case|:
case|case
name|FORCED
case|:
break|break;
case|case
name|LOCK_FAILURE
case|:
case|case
name|IO_FAILURE
case|:
case|case
name|NOT_ATTEMPTED
case|:
case|case
name|REJECTED
case|:
case|case
name|REJECTED_CURRENT_BRANCH
case|:
case|case
name|REJECTED_MISSING_OBJECT
case|:
case|case
name|REJECTED_OTHER_REASON
case|:
default|default:
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Updating external IDs failed with "
operator|+
name|res
argument_list|)
throw|;
block|}
return|return
name|noteId
operator|.
name|getName
argument_list|()
return|;
block|}
block|}
DECL|method|createExternalIdForNonExistingAccount (String externalId)
specifier|private
name|ExternalId
name|createExternalIdForNonExistingAccount
parameter_list|(
name|String
name|externalId
parameter_list|)
block|{
return|return
name|ExternalId
operator|.
name|create
argument_list|(
name|ExternalId
operator|.
name|Key
operator|.
name|parse
argument_list|(
name|externalId
argument_list|)
argument_list|,
operator|new
name|Account
operator|.
name|Id
argument_list|(
literal|1
argument_list|)
argument_list|)
return|;
block|}
DECL|method|createExternalIdWithInvalidEmail (String externalId)
specifier|private
name|ExternalId
name|createExternalIdWithInvalidEmail
parameter_list|(
name|String
name|externalId
parameter_list|)
block|{
return|return
name|ExternalId
operator|.
name|createWithEmail
argument_list|(
name|ExternalId
operator|.
name|Key
operator|.
name|parse
argument_list|(
name|externalId
argument_list|)
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|,
literal|"invalid-email"
argument_list|)
return|;
block|}
DECL|method|createExternalIdWithDuplicateEmail (String externalId)
specifier|private
name|ExternalId
name|createExternalIdWithDuplicateEmail
parameter_list|(
name|String
name|externalId
parameter_list|)
block|{
return|return
name|ExternalId
operator|.
name|createWithEmail
argument_list|(
name|ExternalId
operator|.
name|Key
operator|.
name|parse
argument_list|(
name|externalId
argument_list|)
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|,
name|admin
operator|.
name|email
argument_list|()
argument_list|)
return|;
block|}
DECL|method|createExternalIdWithBadPassword (String username)
specifier|private
name|ExternalId
name|createExternalIdWithBadPassword
parameter_list|(
name|String
name|username
parameter_list|)
block|{
return|return
name|ExternalId
operator|.
name|create
argument_list|(
name|ExternalId
operator|.
name|Key
operator|.
name|create
argument_list|(
name|SCHEME_USERNAME
argument_list|,
name|username
argument_list|)
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|,
literal|null
argument_list|,
literal|"non-hashed-password-is-not-allowed"
argument_list|)
return|;
block|}
DECL|method|nextId (String scheme, MutableInteger i)
specifier|private
specifier|static
name|String
name|nextId
parameter_list|(
name|String
name|scheme
parameter_list|,
name|MutableInteger
name|i
parameter_list|)
block|{
return|return
name|scheme
operator|+
literal|":foo"
operator|+
operator|++
name|i
operator|.
name|value
return|;
block|}
annotation|@
name|Test
DECL|method|readExternalIdWithAccountIdThatCanBeExpressedInKiB ()
specifier|public
name|void
name|readExternalIdWithAccountIdThatCanBeExpressedInKiB
parameter_list|()
throws|throws
name|Exception
block|{
name|ExternalId
operator|.
name|Key
name|extIdKey
init|=
name|ExternalId
operator|.
name|Key
operator|.
name|parse
argument_list|(
literal|"foo:bar"
argument_list|)
decl_stmt|;
name|Account
operator|.
name|Id
name|accountId
init|=
operator|new
name|Account
operator|.
name|Id
argument_list|(
literal|1024
operator|*
literal|100
argument_list|)
decl_stmt|;
name|accountsUpdateProvider
operator|.
name|get
argument_list|()
operator|.
name|insert
argument_list|(
literal|"Create Account with Bad External ID"
argument_list|,
name|accountId
argument_list|,
name|u
lambda|->
name|u
operator|.
name|addExternalId
argument_list|(
name|ExternalId
operator|.
name|create
argument_list|(
name|extIdKey
argument_list|,
name|accountId
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|Optional
argument_list|<
name|ExternalId
argument_list|>
name|extId
init|=
name|externalIds
operator|.
name|get
argument_list|(
name|extIdKey
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|extId
operator|.
name|map
argument_list|(
name|ExternalId
operator|::
name|accountId
argument_list|)
argument_list|)
operator|.
name|hasValue
argument_list|(
name|accountId
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|checkNoReloadAfterUpdate ()
specifier|public
name|void
name|checkNoReloadAfterUpdate
parameter_list|()
throws|throws
name|Exception
block|{
name|Set
argument_list|<
name|ExternalId
argument_list|>
name|expectedExtIds
init|=
operator|new
name|HashSet
argument_list|<>
argument_list|(
name|externalIds
operator|.
name|byAccount
argument_list|(
name|admin
operator|.
name|id
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
try|try
init|(
name|AutoCloseable
name|ctx
init|=
name|createFailOnLoadContext
argument_list|()
init|)
block|{
comment|// insert external ID
name|ExternalId
name|extId
init|=
name|ExternalId
operator|.
name|create
argument_list|(
literal|"foo"
argument_list|,
literal|"bar"
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|)
decl_stmt|;
name|insertExtId
argument_list|(
name|extId
argument_list|)
expr_stmt|;
name|expectedExtIds
operator|.
name|add
argument_list|(
name|extId
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|externalIds
operator|.
name|byAccount
argument_list|(
name|admin
operator|.
name|id
argument_list|()
argument_list|)
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|expectedExtIds
argument_list|)
expr_stmt|;
comment|// update external ID
name|expectedExtIds
operator|.
name|remove
argument_list|(
name|extId
argument_list|)
expr_stmt|;
name|ExternalId
name|extId2
init|=
name|ExternalId
operator|.
name|createWithEmail
argument_list|(
literal|"foo"
argument_list|,
literal|"bar"
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|,
literal|"foo.bar@example.com"
argument_list|)
decl_stmt|;
name|accountsUpdateProvider
operator|.
name|get
argument_list|()
operator|.
name|update
argument_list|(
literal|"Update External ID"
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|,
name|u
lambda|->
name|u
operator|.
name|updateExternalId
argument_list|(
name|extId2
argument_list|)
argument_list|)
expr_stmt|;
name|expectedExtIds
operator|.
name|add
argument_list|(
name|extId2
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|externalIds
operator|.
name|byAccount
argument_list|(
name|admin
operator|.
name|id
argument_list|()
argument_list|)
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|expectedExtIds
argument_list|)
expr_stmt|;
comment|// delete external ID
name|accountsUpdateProvider
operator|.
name|get
argument_list|()
operator|.
name|update
argument_list|(
literal|"Delete External ID"
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|,
name|u
lambda|->
name|u
operator|.
name|deleteExternalId
argument_list|(
name|extId
argument_list|)
argument_list|)
expr_stmt|;
name|expectedExtIds
operator|.
name|remove
argument_list|(
name|extId2
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|externalIds
operator|.
name|byAccount
argument_list|(
name|admin
operator|.
name|id
argument_list|()
argument_list|)
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|expectedExtIds
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|byAccountFailIfReadingExternalIdsFails ()
specifier|public
name|void
name|byAccountFailIfReadingExternalIdsFails
parameter_list|()
throws|throws
name|Exception
block|{
try|try
init|(
name|AutoCloseable
name|ctx
init|=
name|createFailOnLoadContext
argument_list|()
init|)
block|{
comment|// update external ID branch so that external IDs need to be reloaded
name|insertExtIdBehindGerritsBack
argument_list|(
name|ExternalId
operator|.
name|create
argument_list|(
literal|"foo"
argument_list|,
literal|"bar"
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|exception
operator|.
name|expect
argument_list|(
name|IOException
operator|.
name|class
argument_list|)
expr_stmt|;
name|externalIds
operator|.
name|byAccount
argument_list|(
name|admin
operator|.
name|id
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|byEmailFailIfReadingExternalIdsFails ()
specifier|public
name|void
name|byEmailFailIfReadingExternalIdsFails
parameter_list|()
throws|throws
name|Exception
block|{
try|try
init|(
name|AutoCloseable
name|ctx
init|=
name|createFailOnLoadContext
argument_list|()
init|)
block|{
comment|// update external ID branch so that external IDs need to be reloaded
name|insertExtIdBehindGerritsBack
argument_list|(
name|ExternalId
operator|.
name|create
argument_list|(
literal|"foo"
argument_list|,
literal|"bar"
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|exception
operator|.
name|expect
argument_list|(
name|IOException
operator|.
name|class
argument_list|)
expr_stmt|;
name|externalIds
operator|.
name|byEmail
argument_list|(
name|admin
operator|.
name|email
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|byAccountUpdateExternalIdsBehindGerritsBack ()
specifier|public
name|void
name|byAccountUpdateExternalIdsBehindGerritsBack
parameter_list|()
throws|throws
name|Exception
block|{
name|Set
argument_list|<
name|ExternalId
argument_list|>
name|expectedExternalIds
init|=
operator|new
name|HashSet
argument_list|<>
argument_list|(
name|externalIds
operator|.
name|byAccount
argument_list|(
name|admin
operator|.
name|id
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|ExternalId
name|newExtId
init|=
name|ExternalId
operator|.
name|create
argument_list|(
literal|"foo"
argument_list|,
literal|"bar"
argument_list|,
name|admin
operator|.
name|id
argument_list|()
argument_list|)
decl_stmt|;
name|insertExtIdBehindGerritsBack
argument_list|(
name|newExtId
argument_list|)
expr_stmt|;
name|expectedExternalIds
operator|.
name|add
argument_list|(
name|newExtId
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|externalIds
operator|.
name|byAccount
argument_list|(
name|admin
operator|.
name|id
argument_list|()
argument_list|)
argument_list|)
operator|.
name|containsExactlyElementsIn
argument_list|(
name|expectedExternalIds
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|unsetEmail ()
specifier|public
name|void
name|unsetEmail
parameter_list|()
throws|throws
name|Exception
block|{
name|ExternalId
name|extId
init|=
name|ExternalId
operator|.
name|createWithEmail
argument_list|(
literal|"x"
argument_list|,
literal|"1"
argument_list|,
name|user
operator|.
name|id
argument_list|()
argument_list|,
literal|"x@example.com"
argument_list|)
decl_stmt|;
name|insertExtId
argument_list|(
name|extId
argument_list|)
expr_stmt|;
name|ExternalId
name|extIdWithoutEmail
init|=
name|ExternalId
operator|.
name|create
argument_list|(
literal|"x"
argument_list|,
literal|"1"
argument_list|,
name|user
operator|.
name|id
argument_list|()
argument_list|)
decl_stmt|;
try|try
init|(
name|Repository
name|allUsersRepo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|allUsers
argument_list|)
init|;
name|MetaDataUpdate
name|md
operator|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|allUsers
argument_list|)
init|)
block|{
name|ExternalIdNotes
name|extIdNotes
init|=
name|externalIdNotesFactory
operator|.
name|load
argument_list|(
name|allUsersRepo
argument_list|)
decl_stmt|;
name|extIdNotes
operator|.
name|upsert
argument_list|(
name|extIdWithoutEmail
argument_list|)
expr_stmt|;
name|extIdNotes
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|extIdNotes
operator|.
name|get
argument_list|(
name|extId
operator|.
name|key
argument_list|()
argument_list|)
argument_list|)
operator|.
name|hasValue
argument_list|(
name|extIdWithoutEmail
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|unsetHttpPassword ()
specifier|public
name|void
name|unsetHttpPassword
parameter_list|()
throws|throws
name|Exception
block|{
name|ExternalId
name|extId
init|=
name|ExternalId
operator|.
name|createWithPassword
argument_list|(
name|ExternalId
operator|.
name|Key
operator|.
name|create
argument_list|(
literal|"y"
argument_list|,
literal|"1"
argument_list|)
argument_list|,
name|user
operator|.
name|id
argument_list|()
argument_list|,
literal|null
argument_list|,
literal|"secret"
argument_list|)
decl_stmt|;
name|insertExtId
argument_list|(
name|extId
argument_list|)
expr_stmt|;
name|ExternalId
name|extIdWithoutPassword
init|=
name|ExternalId
operator|.
name|create
argument_list|(
literal|"y"
argument_list|,
literal|"1"
argument_list|,
name|user
operator|.
name|id
argument_list|()
argument_list|)
decl_stmt|;
try|try
init|(
name|Repository
name|allUsersRepo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|allUsers
argument_list|)
init|;
name|MetaDataUpdate
name|md
operator|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|allUsers
argument_list|)
init|)
block|{
name|ExternalIdNotes
name|extIdNotes
init|=
name|externalIdNotesFactory
operator|.
name|load
argument_list|(
name|allUsersRepo
argument_list|)
decl_stmt|;
name|extIdNotes
operator|.
name|upsert
argument_list|(
name|extIdWithoutPassword
argument_list|)
expr_stmt|;
name|extIdNotes
operator|.
name|commit
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|extIdNotes
operator|.
name|get
argument_list|(
name|extId
operator|.
name|key
argument_list|()
argument_list|)
argument_list|)
operator|.
name|hasValue
argument_list|(
name|extIdWithoutPassword
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|footers ()
specifier|public
name|void
name|footers
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Insert external ID for different accounts
name|TestAccount
name|user1
init|=
name|accountCreator
operator|.
name|create
argument_list|(
literal|"user1"
argument_list|)
decl_stmt|;
name|TestAccount
name|user2
init|=
name|accountCreator
operator|.
name|create
argument_list|(
literal|"user2"
argument_list|)
decl_stmt|;
name|ExternalId
name|extId1
init|=
name|ExternalId
operator|.
name|create
argument_list|(
literal|"foo"
argument_list|,
literal|"1"
argument_list|,
name|user1
operator|.
name|id
argument_list|()
argument_list|)
decl_stmt|;
name|ExternalId
name|extId2
init|=
name|ExternalId
operator|.
name|create
argument_list|(
literal|"foo"
argument_list|,
literal|"2"
argument_list|,
name|user1
operator|.
name|id
argument_list|()
argument_list|)
decl_stmt|;
name|ExternalId
name|extId3
init|=
name|ExternalId
operator|.
name|create
argument_list|(
literal|"foo"
argument_list|,
literal|"3"
argument_list|,
name|user2
operator|.
name|id
argument_list|()
argument_list|)
decl_stmt|;
try|try
init|(
name|Repository
name|allUsersRepo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|allUsers
argument_list|)
init|;
name|MetaDataUpdate
name|md
operator|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|allUsers
argument_list|)
init|)
block|{
name|ExternalIdNotes
name|extIdNotes
init|=
name|externalIdNotesFactory
operator|.
name|load
argument_list|(
name|allUsersRepo
argument_list|)
decl_stmt|;
name|extIdNotes
operator|.
name|insert
argument_list|(
name|ImmutableSet
operator|.
name|of
argument_list|(
name|extId1
argument_list|,
name|extId2
argument_list|,
name|extId3
argument_list|)
argument_list|)
expr_stmt|;
name|RevCommit
name|c
init|=
name|extIdNotes
operator|.
name|commit
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|getFooters
argument_list|(
name|c
argument_list|)
argument_list|)
operator|.
name|containsExactly
argument_list|(
literal|"Account: "
operator|+
name|user1
operator|.
name|id
argument_list|()
argument_list|,
literal|"Account: "
operator|+
name|user2
operator|.
name|id
argument_list|()
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
comment|// Insert external ID with different emails
name|ExternalId
name|extId4
init|=
name|ExternalId
operator|.
name|createWithEmail
argument_list|(
literal|"foo"
argument_list|,
literal|"4"
argument_list|,
name|user1
operator|.
name|id
argument_list|()
argument_list|,
literal|"foo4@example.com"
argument_list|)
decl_stmt|;
name|ExternalId
name|extId5
init|=
name|ExternalId
operator|.
name|createWithEmail
argument_list|(
literal|"foo"
argument_list|,
literal|"5"
argument_list|,
name|user2
operator|.
name|id
argument_list|()
argument_list|,
literal|"foo5@example.com"
argument_list|)
decl_stmt|;
try|try
init|(
name|Repository
name|allUsersRepo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|allUsers
argument_list|)
init|;
name|MetaDataUpdate
name|md
operator|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|allUsers
argument_list|)
init|)
block|{
name|ExternalIdNotes
name|extIdNotes
init|=
name|externalIdNotesFactory
operator|.
name|load
argument_list|(
name|allUsersRepo
argument_list|)
decl_stmt|;
name|extIdNotes
operator|.
name|insert
argument_list|(
name|ImmutableSet
operator|.
name|of
argument_list|(
name|extId4
argument_list|,
name|extId5
argument_list|)
argument_list|)
expr_stmt|;
name|RevCommit
name|c
init|=
name|extIdNotes
operator|.
name|commit
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|getFooters
argument_list|(
name|c
argument_list|)
argument_list|)
operator|.
name|containsExactly
argument_list|(
literal|"Account: "
operator|+
name|user1
operator|.
name|id
argument_list|()
argument_list|,
literal|"Account: "
operator|+
name|user2
operator|.
name|id
argument_list|()
argument_list|,
literal|"Email: foo4@example.com"
argument_list|,
literal|"Email: foo5@example.com"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
comment|// Update external ID - Add Email
name|ExternalId
name|extId1a
init|=
name|ExternalId
operator|.
name|createWithEmail
argument_list|(
literal|"foo"
argument_list|,
literal|"1"
argument_list|,
name|user1
operator|.
name|id
argument_list|()
argument_list|,
literal|"foo1@example.com"
argument_list|)
decl_stmt|;
try|try
init|(
name|Repository
name|allUsersRepo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|allUsers
argument_list|)
init|;
name|MetaDataUpdate
name|md
operator|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|allUsers
argument_list|)
init|)
block|{
name|ExternalIdNotes
name|extIdNotes
init|=
name|externalIdNotesFactory
operator|.
name|load
argument_list|(
name|allUsersRepo
argument_list|)
decl_stmt|;
name|extIdNotes
operator|.
name|upsert
argument_list|(
name|extId1a
argument_list|)
expr_stmt|;
name|RevCommit
name|c
init|=
name|extIdNotes
operator|.
name|commit
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|getFooters
argument_list|(
name|c
argument_list|)
argument_list|)
operator|.
name|containsExactly
argument_list|(
literal|"Account: "
operator|+
name|user1
operator|.
name|id
argument_list|()
argument_list|,
literal|"Email: foo1@example.com"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
comment|// Update external ID - Remove Email
try|try
init|(
name|Repository
name|allUsersRepo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|allUsers
argument_list|)
init|;
name|MetaDataUpdate
name|md
operator|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|allUsers
argument_list|)
init|)
block|{
name|ExternalIdNotes
name|extIdNotes
init|=
name|externalIdNotesFactory
operator|.
name|load
argument_list|(
name|allUsersRepo
argument_list|)
decl_stmt|;
name|extIdNotes
operator|.
name|upsert
argument_list|(
name|extId1
argument_list|)
expr_stmt|;
name|RevCommit
name|c
init|=
name|extIdNotes
operator|.
name|commit
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|getFooters
argument_list|(
name|c
argument_list|)
argument_list|)
operator|.
name|containsExactly
argument_list|(
literal|"Account: "
operator|+
name|user1
operator|.
name|id
argument_list|()
argument_list|,
literal|"Email: foo1@example.com"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
comment|// Delete external IDs
try|try
init|(
name|Repository
name|allUsersRepo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|allUsers
argument_list|)
init|;
name|MetaDataUpdate
name|md
operator|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|allUsers
argument_list|)
init|)
block|{
name|ExternalIdNotes
name|extIdNotes
init|=
name|externalIdNotesFactory
operator|.
name|load
argument_list|(
name|allUsersRepo
argument_list|)
decl_stmt|;
name|extIdNotes
operator|.
name|delete
argument_list|(
name|ImmutableSet
operator|.
name|of
argument_list|(
name|extId1
argument_list|,
name|extId5
argument_list|)
argument_list|)
expr_stmt|;
name|RevCommit
name|c
init|=
name|extIdNotes
operator|.
name|commit
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|getFooters
argument_list|(
name|c
argument_list|)
argument_list|)
operator|.
name|containsExactly
argument_list|(
literal|"Account: "
operator|+
name|user1
operator|.
name|id
argument_list|()
argument_list|,
literal|"Account: "
operator|+
name|user2
operator|.
name|id
argument_list|()
argument_list|,
literal|"Email: foo5@example.com"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
comment|// Delete external ID by key without email
try|try
init|(
name|Repository
name|allUsersRepo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|allUsers
argument_list|)
init|;
name|MetaDataUpdate
name|md
operator|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|allUsers
argument_list|)
init|)
block|{
name|ExternalIdNotes
name|extIdNotes
init|=
name|externalIdNotesFactory
operator|.
name|load
argument_list|(
name|allUsersRepo
argument_list|)
decl_stmt|;
name|extIdNotes
operator|.
name|delete
argument_list|(
name|extId2
operator|.
name|accountId
argument_list|()
argument_list|,
name|extId2
operator|.
name|key
argument_list|()
argument_list|)
expr_stmt|;
name|RevCommit
name|c
init|=
name|extIdNotes
operator|.
name|commit
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|getFooters
argument_list|(
name|c
argument_list|)
argument_list|)
operator|.
name|containsExactly
argument_list|(
literal|"Account: "
operator|+
name|user1
operator|.
name|id
argument_list|()
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
comment|// Delete external ID by key with email
try|try
init|(
name|Repository
name|allUsersRepo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|allUsers
argument_list|)
init|;
name|MetaDataUpdate
name|md
operator|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|allUsers
argument_list|)
init|)
block|{
name|ExternalIdNotes
name|extIdNotes
init|=
name|externalIdNotesFactory
operator|.
name|load
argument_list|(
name|allUsersRepo
argument_list|)
decl_stmt|;
name|extIdNotes
operator|.
name|delete
argument_list|(
name|extId4
operator|.
name|accountId
argument_list|()
argument_list|,
name|extId4
operator|.
name|key
argument_list|()
argument_list|)
expr_stmt|;
name|RevCommit
name|c
init|=
name|extIdNotes
operator|.
name|commit
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|getFooters
argument_list|(
name|c
argument_list|)
argument_list|)
operator|.
name|containsExactly
argument_list|(
literal|"Account: "
operator|+
name|user1
operator|.
name|id
argument_list|()
argument_list|,
literal|"Email: foo4@example.com"
argument_list|)
operator|.
name|inOrder
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|insertExtId (ExternalId extId)
specifier|private
name|void
name|insertExtId
parameter_list|(
name|ExternalId
name|extId
parameter_list|)
throws|throws
name|Exception
block|{
name|accountsUpdateProvider
operator|.
name|get
argument_list|()
operator|.
name|update
argument_list|(
literal|"Add External ID"
argument_list|,
name|extId
operator|.
name|accountId
argument_list|()
argument_list|,
name|u
lambda|->
name|u
operator|.
name|addExternalId
argument_list|(
name|extId
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|insertExtIdForNonExistingAccount (ExternalId extId)
specifier|private
name|void
name|insertExtIdForNonExistingAccount
parameter_list|(
name|ExternalId
name|extId
parameter_list|)
throws|throws
name|Exception
block|{
comment|// Cannot use AccountsUpdate to insert an external ID for a non-existing account.
try|try
init|(
name|Repository
name|repo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|allUsers
argument_list|)
init|;
name|MetaDataUpdate
name|update
operator|=
name|metaDataUpdateFactory
operator|.
name|create
argument_list|(
name|allUsers
argument_list|)
init|)
block|{
name|ExternalIdNotes
name|extIdNotes
init|=
name|externalIdNotesFactory
operator|.
name|load
argument_list|(
name|repo
argument_list|)
decl_stmt|;
name|extIdNotes
operator|.
name|insert
argument_list|(
name|extId
argument_list|)
expr_stmt|;
name|extIdNotes
operator|.
name|commit
argument_list|(
name|update
argument_list|)
expr_stmt|;
name|extIdNotes
operator|.
name|updateCaches
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|insertExtIdBehindGerritsBack (ExternalId extId)
specifier|private
name|void
name|insertExtIdBehindGerritsBack
parameter_list|(
name|ExternalId
name|extId
parameter_list|)
throws|throws
name|Exception
block|{
try|try
init|(
name|Repository
name|repo
init|=
name|repoManager
operator|.
name|openRepository
argument_list|(
name|allUsers
argument_list|)
init|)
block|{
comment|// Inserting an external ID "behind Gerrit's back" means that the caches are not updated.
name|ExternalIdNotes
name|extIdNotes
init|=
name|ExternalIdNotes
operator|.
name|loadNoCacheUpdate
argument_list|(
name|allUsers
argument_list|,
name|repo
argument_list|)
decl_stmt|;
name|extIdNotes
operator|.
name|insert
argument_list|(
name|extId
argument_list|)
expr_stmt|;
try|try
init|(
name|MetaDataUpdate
name|metaDataUpdate
init|=
operator|new
name|MetaDataUpdate
argument_list|(
name|GitReferenceUpdated
operator|.
name|DISABLED
argument_list|,
literal|null
argument_list|,
name|repo
argument_list|)
init|)
block|{
name|metaDataUpdate
operator|.
name|getCommitBuilder
argument_list|()
operator|.
name|setAuthor
argument_list|(
name|admin
operator|.
name|newIdent
argument_list|()
argument_list|)
expr_stmt|;
name|metaDataUpdate
operator|.
name|getCommitBuilder
argument_list|()
operator|.
name|setCommitter
argument_list|(
name|admin
operator|.
name|newIdent
argument_list|()
argument_list|)
expr_stmt|;
name|extIdNotes
operator|.
name|commit
argument_list|(
name|metaDataUpdate
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|addExtId (TestRepository<?> testRepo, ExternalId... extIds)
specifier|private
name|void
name|addExtId
parameter_list|(
name|TestRepository
argument_list|<
name|?
argument_list|>
name|testRepo
parameter_list|,
name|ExternalId
modifier|...
name|extIds
parameter_list|)
throws|throws
name|IOException
throws|,
name|DuplicateKeyException
throws|,
name|ConfigInvalidException
block|{
name|ExternalIdNotes
name|extIdNotes
init|=
name|externalIdNotesFactory
operator|.
name|load
argument_list|(
name|testRepo
operator|.
name|getRepository
argument_list|()
argument_list|)
decl_stmt|;
name|extIdNotes
operator|.
name|insert
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|extIds
argument_list|)
argument_list|)
expr_stmt|;
try|try
init|(
name|MetaDataUpdate
name|metaDataUpdate
init|=
operator|new
name|MetaDataUpdate
argument_list|(
name|GitReferenceUpdated
operator|.
name|DISABLED
argument_list|,
literal|null
argument_list|,
name|testRepo
operator|.
name|getRepository
argument_list|()
argument_list|)
init|)
block|{
name|metaDataUpdate
operator|.
name|getCommitBuilder
argument_list|()
operator|.
name|setAuthor
argument_list|(
name|admin
operator|.
name|newIdent
argument_list|()
argument_list|)
expr_stmt|;
name|metaDataUpdate
operator|.
name|getCommitBuilder
argument_list|()
operator|.
name|setCommitter
argument_list|(
name|admin
operator|.
name|newIdent
argument_list|()
argument_list|)
expr_stmt|;
name|extIdNotes
operator|.
name|commit
argument_list|(
name|metaDataUpdate
argument_list|)
expr_stmt|;
name|extIdNotes
operator|.
name|updateCaches
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|getFooters (RevCommit c)
specifier|private
name|List
argument_list|<
name|String
argument_list|>
name|getFooters
parameter_list|(
name|RevCommit
name|c
parameter_list|)
block|{
return|return
name|c
operator|.
name|getFooterLines
argument_list|()
operator|.
name|stream
argument_list|()
operator|.
name|map
argument_list|(
name|FooterLine
operator|::
name|toString
argument_list|)
operator|.
name|collect
argument_list|(
name|toList
argument_list|()
argument_list|)
return|;
block|}
DECL|method|toExternalIdInfos (Collection<ExternalId> extIds)
specifier|private
name|List
argument_list|<
name|AccountExternalIdInfo
argument_list|>
name|toExternalIdInfos
parameter_list|(
name|Collection
argument_list|<
name|ExternalId
argument_list|>
name|extIds
parameter_list|)
block|{
return|return
name|extIds
operator|.
name|stream
argument_list|()
operator|.
name|map
argument_list|(
name|this
operator|::
name|toExternalIdInfo
argument_list|)
operator|.
name|collect
argument_list|(
name|toList
argument_list|()
argument_list|)
return|;
block|}
DECL|method|toExternalIdInfo (ExternalId extId)
specifier|private
name|AccountExternalIdInfo
name|toExternalIdInfo
parameter_list|(
name|ExternalId
name|extId
parameter_list|)
block|{
name|AccountExternalIdInfo
name|info
init|=
operator|new
name|AccountExternalIdInfo
argument_list|()
decl_stmt|;
name|info
operator|.
name|identity
operator|=
name|extId
operator|.
name|key
argument_list|()
operator|.
name|get
argument_list|()
expr_stmt|;
name|info
operator|.
name|emailAddress
operator|=
name|extId
operator|.
name|email
argument_list|()
expr_stmt|;
name|info
operator|.
name|canDelete
operator|=
operator|!
name|extId
operator|.
name|isScheme
argument_list|(
name|SCHEME_USERNAME
argument_list|)
condition|?
literal|true
else|:
literal|null
expr_stmt|;
name|info
operator|.
name|trusted
operator|=
name|extId
operator|.
name|isScheme
argument_list|(
name|SCHEME_MAILTO
argument_list|)
operator|||
name|extId
operator|.
name|isScheme
argument_list|(
name|SCHEME_UUID
argument_list|)
operator|||
name|extId
operator|.
name|isScheme
argument_list|(
name|SCHEME_USERNAME
argument_list|)
condition|?
literal|true
else|:
literal|null
expr_stmt|;
return|return
name|info
return|;
block|}
DECL|method|allowPushOfExternalIds ()
specifier|private
name|void
name|allowPushOfExternalIds
parameter_list|()
throws|throws
name|IOException
throws|,
name|ConfigInvalidException
block|{
name|grant
argument_list|(
name|allUsers
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|,
name|Permission
operator|.
name|READ
argument_list|)
expr_stmt|;
name|grant
argument_list|(
name|allUsers
argument_list|,
name|RefNames
operator|.
name|REFS_EXTERNAL_IDS
argument_list|,
name|Permission
operator|.
name|PUSH
argument_list|)
expr_stmt|;
block|}
DECL|method|assertRefUpdateFailure (RemoteRefUpdate update, String msg)
specifier|private
name|void
name|assertRefUpdateFailure
parameter_list|(
name|RemoteRefUpdate
name|update
parameter_list|,
name|String
name|msg
parameter_list|)
block|{
name|assertThat
argument_list|(
name|update
operator|.
name|getStatus
argument_list|()
argument_list|)
operator|.
name|isEqualTo
argument_list|(
name|Status
operator|.
name|REJECTED_OTHER_REASON
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|update
operator|.
name|getMessage
argument_list|()
argument_list|)
operator|.
name|contains
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
DECL|method|createFailOnLoadContext ()
specifier|private
name|AutoCloseable
name|createFailOnLoadContext
parameter_list|()
block|{
name|externalIdReader
operator|.
name|setFailOnLoad
argument_list|(
literal|true
argument_list|)
expr_stmt|;
return|return
parameter_list|()
lambda|->
name|externalIdReader
operator|.
name|setFailOnLoad
argument_list|(
literal|false
argument_list|)
return|;
block|}
annotation|@
name|FunctionalInterface
DECL|interface|ExternalIdInserter
specifier|private
interface|interface
name|ExternalIdInserter
block|{
DECL|method|addNote (ObjectInserter ins, NoteMap noteMap)
specifier|public
name|ObjectId
name|addNote
parameter_list|(
name|ObjectInserter
name|ins
parameter_list|,
name|NoteMap
name|noteMap
parameter_list|)
throws|throws
name|IOException
function_decl|;
block|}
block|}
end_class

end_unit

